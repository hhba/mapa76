<!DOCTYPE html>
<html>
<head>
  <title>Mapa</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
  <style type="text/css">
    html {
      height: 100%;
    }
    body {
      height: 100%;
      margin: 0px;
      padding: 0px;
      font-family: Helvetica;
    }
    #map_canvas {
      height: 100%;
      width: 100%;
    }
  </style>

  <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
  <script type="text/javascript">
    function initialize() {
      var latlng = new google.maps.LatLng(<%= @center.lat %>, <%= @center.lng %>);
      var myOptions = {
        zoom: 11,
        center: latlng,
        mapTypeId: google.maps.MapTypeId.ROADMAP
      };
      var map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
      var infoTemplate = $("#info-template");
      var lastInfowindow = null;

      <% @addresses.each do |addr| %>
        (function() {
          var myLatlng = new google.maps.LatLng(<%= addr.lat %>, <%= addr.lng %>);
          var myOptions = {
            zoom: 4,
            center: myLatlng,
            mapTypeId: google.maps.MapTypeId.ROADMAP
          };
          if (!centered) {
            centered = true;
            map.panTo(myLatlng);
          }
          var title = <%= addr.text.to_json %>;
          var infowindow = new google.maps.InfoWindow({
            content: Mustache.render(infoTemplate.html(), {
              title: title,
              context: <%= addr.context(150).gsub(addr.text, "<b>#{addr.text}</b>").to_json %>,
              document_id: <%= addr.document_id.to_s.to_json %>,
              document_title: <%= addr.document.heading.to_json %>,
              page_num: <%= Page.where(:_id => addr.inner_pos["from"]["pid"]).only(:num).first.try(:num).to_json %>
            })
          });
          var marker = new google.maps.Marker({
            position: myLatlng,
            map: map,
            title: title
          });
          google.maps.event.addListener(marker, "click", function() {
            if (lastInfowindow) lastInfowindow.close();
            infowindow.open(map, marker);
            lastInfowindow = infowindow;
          });
        })();
      <% end %>
    }
    centered = false;
  </script>
</head>

<body onload="initialize()">
  <div id="map_canvas" ></div>

  <script id="info-template" type="text/template">
    <h3>{{ title }}</h3>
    <p><i>[...]</i>{{{ context }}}<i>[...]</i></p>
    <p>Mencionado en la <a href="/documents/{{ document_id }}/comb#{{ page_num }}">p√°gina {{ page_num }}</a></p>
  </script>
</body>

<%= javascript_include_tag 'javascripts/jquery-1.7.2.min', 'javascripts/mustache.js' %>

</html>
